# PES Data
This directory doesn't contain the parent datasets used to create the state-specific files, due to file size limitations, but the empty directories where data should be stored are labeled in each scripts header under "Parent dirs". See `../scripts/` dir for further details.

We also include example templates in 'INPUT_TEMPLATES' for each model that can be modified by hand or with a script similar to how the state-specific files were created. See `../scripts/6_create_input_files_and_parallel_commands.R` for further demonstration.

## Generating Parent Datasets

### Between Node Mobility Networks - `3a_ct_ak_crosswalks.R` and `3b_county_mobility_timeseries_post2020census.R` 
1. [Alaska](https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.2010.html#list-tab-957819518) split one county into 2 in 2019, but this change was not commonly used until after the pandemic and 2020 census. We created this crosswalk manually by determining the proportion of the 2019-2023 ACS population in each new county (69% and 31% split). 
2. [Connecticut](https://www.census.gov/programs-surveys/geography/technical-documentation/county-changes.January_2020.html) changed their county names and boundaries in 2023 to Planning Regions. [GeoCorr 2022](https://mcdc.missouri.edu/applications/geocorr2022.html) provides crosswalks across US boundaries including a Connecticut pre-2023 boundary under "Other geographies". CT crosswalk in `MOBILITY/connecticut_county_crosswalk_geocorr2022.csv` and combined with AK in `MOBILITY/ak_ct_crosswalk.csv`
3. With the county crosswalk created, we translated each day of the 2019 SafeGraph county mobility visits to 2023 census boundaries and reduced the data to only within-state pairs. The AK and CT conversion created some rounding errors in population increasing the total daily flow by 40-50 people per county. The estimated  population traveling each day far exceed the 2019-2023 census estimates of the population within each county already, because cell-phone data captures flow of non-residents as well. We used the fraction of the total outflow per county to derive the proportions of the population traveling. We grouped daily travel by quarter of the year and provide all four, but Q4 is likely the most appropriate for modeling the influenza season in the US. Future code iterations may allow daily mobility matrices, but currently an average one is used for the entire time series. We also provide `STATE/STATE_quarterly-2019_county-connection-ranking.csv` with the total people flowing out of a county each day to help target which counties may have the largest impact on the community when infections are seeded there. Created datasets can be found in `MOBILITY/` and their respective `STATE` directories once the `../scripts` pipeline is run.

### High Risk Ratios - `4a_flu_state_high_risk_by_age.R` and `4b_flu_county_high_risk_by_age.R`
1. [Behavioral Risk Factor Surveillance System (BRFSS)](https://www.cdc.gov/brfss/annual_data/annual_data.htm) is a continual survey released annually of Americans 18+ to estimate the proportion of the population experiencing comorbidities and taking part in risky behaviors such as smoking. We use the [CDC's list of comorbidities](https://www.cdc.gov/flu/highrisk/index.htm) that increase the risk of hospitalization and death for adults to pull out the proportion of the population with at least one comorbidity and do not scale risk by multiple comorbidities. Anyone 65+ is technically high risk due to age, but we leave this to the user and estimate comorbid risk for this age group the same as 18-49 and 50-64.  Data files needed are `BRFSS/LLCP202*.XPT`, 2023 and 2024 are needed because Tennessee did not collect enough data in 2024.
2. [National Survey of Children's Health (NSCH)](https://www.census.gov/programs-surveys/nsch/data/datasets.2023.html) surveys parents to assess the comorbidity burden of children 17 and under. The CDC provides a [separate list of high risk comorbidities for children](https://www.cdc.gov/flu/highrisk/neurologic-pediatric.html). Both BRFSS and NSCH provide the respondent's age group, current state, strata and primary sampling unit to allow for adjusted prevalence estimates. Data file needed is `NSCH/nsch_2024e_topical.sas7bdat`.
3. [Social Vulnerability Index (SVI) 2022 release](https://www.atsdr.cdc.gov/place-health/php/svi/svi-data-documentation-download.html) is derived from the 5-year American Community Survey based on 16 factors that increase someone's likelihood of suffering or struggling to recover after a natural disaster, such as a hurricane or pandemic. It is a percentile rank that will always have a lowest vulnerability (0) and highest (1), so we use the US level ranking rather than state specific to compare the SVI at county-level to the CDC PLACES data below.  Data file needed is `SVI/SVI_2022_US_county.csv`.
4. [CDC PLACES](https://www.cdc.gov/places/index.html) combines BRFSS, ACS and SVI with other datasets to generate county, census tract, and ZIP Code Tabulation Area (ZCTA)-level estimates of the proportion of different comorbidities and risky behaviors. It does not, however, provide the proportion of the population with at least 1 high risk influenza comorbidity at these granular levels.  Data files needed are `PLACES/PLACES__Local_Data_for_Better_Health,_County_Data_2024_release_*.csv` and `PLACES__Local_Data_for_Better_Health,_County_Data,_2025_release_*.csv` because on release day Dec 5, 2025 both Kentucky (21) and Pennsylvania (42) were missing from 2025 release.

The only core stipulation of the county-level high risk ratios is their mean needs to re-create the mean high risk of the state by age group, but otherwise it is a hypothesis how risk is distributed within the state. Some notes on our choice:
- SVI isn't directly used here to allocate risk, but we only kept PLACES comorbidities that increased with SVI (see `../figures/places_comorbs_svi_comparison.png`). Cancer prevalence was the only comorbidity negatively associated with SVI as it includes skin cancer, a disease typical of white, affluent people. While chronic kidney disease prevalence was not included in the 2024 release. A full list of comorbidities included is found in the scripts pipeline. 
- We assume the risk distribution for children is the same as adults, since PLACES is only available for 18+ population. The percent high risk is low so the county specific values do not deviate from the mean as much as they do for the 65+ age group.
- We square-root the raw sum of county comorbidity prevalences to limit the influence of high-burden counties, e.g. prevalences of 1.5 and 2.5 become 1.22 and 1.58, respectively. Using the raw burden would also be valid but there is a larger range/spread of the county min and max high risk ratios.

We carried out the following steps per state ($s$) and age group ($a$). First, we sum the PLACES county-level age-adjusted comorbidity prevalences to get the total raw burden ($p_{s,a,c}$) and square-root ($q_{s,a,c}$) to dampen extremes. State high risk ratios can be thought of as the proportion of the state by age group with at least 1 influenza high risk comorbidity, so we can use this to normalize the absolute prevalence sums. Second, we estimate each county's proportion of the total state population ($w_{s,a,c}$) and compute a weighted average to get the mean burden of the state ($b_{s,a} = \sum_{c} q_{s,a,c} * w_{s,a,c}$). Lastly, each county receives a relative burden weight ($r_{s,a,c} = q_{s,a,c} / b_{s,a}$) and we allocate the county-level high risk prevalence ($h_{s,a,c} = h_{s,a} * r_{s,a,c}$). The allocation method ensures $\sum_{c} w_{s,a,c} * h_{s,a,c} = h_{s,a}$. 

### Vaccination - `5_vaccine_coverage_by_state.R`
1. [Pediatric vaccine coverage](https://data.cdc.gov/Vaccinations/Weekly-Cumulative-Influenza-Vaccination-Coverage-C/eudc-n39h/about_data) is the weekly proportion of the 6mon-17yr population vaccinated for influenza, so it's a monotonic increasing value. The national data is age stratified, but we chose the state stratified coverage for the 2024-2025 influenza season to better reflect the heterogeneity amongst states.
2. [Adult vaccine coverage](https://data.cdc.gov/Flu-Vaccinations/Weekly-Influenza-Vaccination-Coverage-and-Intent-f/sw5n-wg2p/about_data) similarly is the percent of of a state's 18+ population who received an influenza vaccine.
3. [Vaccine effectiveness for 2023-24](https://www.cdc.gov/flu-vaccines-work/php/effectiveness-studies/2023-2024.html) influenza season is available for both pediatric and adult populations. We parameterized the model for H1N1, so chose NVSN (Inpatient) VE for pediatric cases (51% effective) and IVY (Inpatient) for adult (36% effective). The [2024-25 season](https://www.cdc.gov/flu-vaccines-work/php/effectiveness-studies/2024-2025.html) data was still marked preliminary at the time of analysis, but would be more appropriate to use with the 2024-25 season vaccine coverage.

We assume the vaccine is 100% effective against infection up to the vaccine effectiveness for each age group. For example, if 100 vaccines were given and VE=36%, then only 36 people have the 100% protection and the remaining 64 have 0% protection (for our purposes not vaccinated). The 100% effectiveness is simplifying assumption to avoid finding the correct parameter combination of protection against infection and hospitalization. 

The vaccination method in the model is a "stockpile release", so each week $n$ vaccine doses become available and are allocated to the population by age and risk group depending on the users strategy. Therefore, we calculate the total adult and pediatric doses that will be 100% effective each week and sum them get the $n$ weekly doses released. We chose for each influenza epidemic to start on Oct. 1, 2024, so anyone vaccinated 14 days before the simulation begins has full immunity. Doses distributed after day 0 release en masse each week rather than daily. Fourteen days after vaccination, the vaccinated susceptibles move to the vaccinated compartment and cannot become infected. If someone is infected before full immunity sets in, then they carry out the infectious time series the same as the unvaccinated population. 

## State-specific Dirs
Each state-specific directory has the files needed to run a SEIHRD model with and without vaccination parameterized for H1N1. For Alabama alone we also provide examples of other models. All input files are based on templates available in `INPUT_FILE_TEMPLATES`. We assume epidemics begin on Oct. 1 (day0 parameter in `5_vaccine_coverage_by_state.R`) and last 212 days (simulation_days parameter in `6_create_input_files_and_parallel_commands.R`). 

The initial infected are placed in the largest age group (low risk, 18-49yr) based on 1 per 1M of the state population, always rounding up to the nearest integer. The lower the initial infected the more stochasticity in final epidemic size. For example, Alaska's population was less than 1M in the in the 2019-2023 5-yr ACS, so only 1 person seeds the simulation. The likelihood a single person can infect enough people to start an epidemic depends on the inter-node mobility, within-node contact structure, disease itself (e.g. R0), and everyone's susceptibility to infection (usually 1 for all ages). 

Running `6_create_input_files_and_parallel_commands.R` generates the output directory `../US_STATES` with `state_commands.txt` of every command needed to run all 50 states + DC under no intervention (baseline) and seasonal vaccination strategies. Before launching a job on TACC it's best to copy one line from `state_commands.txt` and ensure it runs successfully. 